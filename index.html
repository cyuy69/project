<!doctype html>
<html lang="en" data-bs-theme="light">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>簽到簽退 | Index</title>
  <script src="assets/js/color-modes.js"></script>
  <link rel="stylesheet" href="assets/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="assets/dist/css/navbars.css" />
  <link rel="stylesheet" href="assets/dist/css/fonts.css" />
  <style>
    body,

    .bi {
      vertical-align: -0.125em;
      fill: currentColor;
    }

    .icon {
      opacity: 0.6;
    }

    main {
      min-height: 100vh;
    }

    #clock {
      font-size: 4rem;
      font-weight: 600;
      letter-spacing: 1px;
      text-align: center;
    }

    #log-area {
      height: 260px;
      overflow-y: auto;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      white-space: pre-line;
    }

    @media (max-width: 576px) {
      #clock {
        font-size: 2.6rem;
      }

      .punch-btn {
        width: 100%;
        margin-bottom: .75rem;
      }
    }

    .btn-login {
      color: #fff;
      background-color: #28a745;
      border-color: #28a745;
      transition: background-color 0.2s, border-color 0.2s;
    }

    .btn-login:hover,
    .btn-login:focus {
      background-color: #218838;
      border-color: #1e7e34;
      color: #fff;
    }

    .btn-login:active,
    .btn-login.active {
      background-color: #1e7e34;
      border-color: #1c7430;
      color: #fff;
    }
  </style>
</head>

<body>
  <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="loginForm" autocomplete="off">
          <div class="modal-header">
            <h5 class="modal-title" id="loginModalLabel">登入</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="關閉"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label for="loginName" class="form-label">姓名</label>
              <input type="text" class="form-control" id="loginName" placeholder="請輸入姓名" required>
            </div>
            <div class="mb-3">
              <label for="loginPassword" class="form-label">密碼</label>
              <input type="password" class="form-control" id="loginPassword" placeholder="請輸入密碼">
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="rememberMe">
              <label class="form-check-label" for="rememberMe">
                記住我
              </label>
            </div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-success w-100">登入</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div id="site-header"></div>
  <main class="d-flex flex-column justify-content-center align-items-center bg-light">
    <div id="clock" class="text-primary mb-4" aria-live="polite">--:--:--</div>
    <div class="mb-4">
      <button type="button" id="btnCheckIn" class="btn btn-success btn-lg px-5 py-3 me-3 punch-btn">簽到</button>
      <button type="button" id="btnCheckOut" class="btn btn-danger  btn-lg px-5 py-3 punch-btn">簽退</button>
    </div>
    <div class="card shadow-lg w-50 w-100" style="max-width: 600px;">
      <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
        <span>Log</span>
        <button id="btnClearLog" class="btn btn-sm btn-outline-light">清空</button>
      </div>
      <div class="card-body bg-white px-3" id="log-area">尚無紀錄</div>
    </div>
  </main>
  <div id="site-footer"></div>

  <script>
    // ===== Partial 載入與 Navbar UI =====
    let currentUser = null;

    async function loadPart(selector, url) {
      try {
        const res = await fetch(url, { cache: "no-store" });
        if (!res.ok) throw new Error(`${url} 載入失敗：${res.status}`);
        document.querySelector(selector).innerHTML = await res.text();

        bindNavbarEvents();
        bindLoginFormEvent();
        if (url.includes('navbar')) updateNavbarUI();
      } catch {
        document.querySelector(selector).innerHTML =
          `<div class="container py-2"><div class="alert alert-warning">無法載入 ${url}，請確認路徑與本機伺服器。</div></div>`;
      }
    }

    function bindNavbarEvents() {
      const loginBtn = document.querySelector('.btn-login');
      if (loginBtn) {
        loginBtn.onclick = () => {
          const modal = new bootstrap.Modal(document.getElementById('loginModal'));
          modal.show();
        };
      }
      const logoutBtn = document.querySelector('.btn-logout');
      if (logoutBtn) {
        logoutBtn.onclick = logout;
      }
      // 綁定「那就改天吧」連結
      const delayLink = document.getElementById('link-delay');
      if (delayLink) {
        delayLink.onclick = (e) => {
          e.preventDefault();
          addDaysToClock(1); // 每次加一天
        };
      }
    }

    function bindLoginFormEvent() {
      const loginForm = document.getElementById('loginForm');
      if (loginForm) {
        // 移除所有舊事件
        const newForm = loginForm.cloneNode(true);
        loginForm.parentNode.replaceChild(newForm, loginForm);
        newForm.addEventListener('submit', handleLoginSubmit);
      }
    }

    function updateNavbarUI() {
      setTimeout(() => {
        const loginBtn = document.querySelector('.btn-login');
        const logoutBtn = document.querySelector('.btn-logout');
        const welcomeSpan = document.querySelector('#welcome-user');
        if (currentUser) {
          if (loginBtn) loginBtn.style.display = 'none';
          if (logoutBtn) {
            logoutBtn.style.display = '';
            logoutBtn.classList.add('btn-danger');
            logoutBtn.classList.remove('btn-login');
            logoutBtn.textContent = '登出';
          }
          if (welcomeSpan) {
            welcomeSpan.textContent = `${currentUser}，你好！`;
            welcomeSpan.style.display = '';
          }
        } else {
          if (loginBtn) loginBtn.style.display = '';
          if (logoutBtn) logoutBtn.style.display = 'none';
          if (welcomeSpan) welcomeSpan.style.display = 'none';
        }
      }, 100);
    }

    function logout() {
      addLog(`${currentUser}，已登出！`);
      currentUser = null;
      // 重置時鐘
      clockBase = new Date();
      clockOffset = 0;
      updateClock();

      updateNavbarUI();
    }

    // ===== 時鐘 =====
    let clockBase = new Date();
    let clockOffset = 0;
    let clockTimer = null;

    function updateClock() {
      const showTime = new Date(clockBase.getTime() + clockOffset * 1000);
      document.getElementById("clock").textContent =
        showTime.toLocaleString("zh-TW", { hour12: false });
      clockOffset++;
    }

    function addDaysToClock(days = 1) {
      // 以目前顯示的時間為基準加天數
      const now = new Date(clockBase.getTime() + clockOffset * 1000);
      now.setDate(now.getDate() + days);
      clockBase = now;
      clockOffset = 0;
      updateClock(); // 立即更新畫面
    }

    // 初始化時鐘
    updateClock();
    if (clockTimer) clearInterval(clockTimer);
    clockTimer = setInterval(updateClock, 1000);

    // ===== Log 工具 =====
    function addLog(action) {
      const ts = document.getElementById("clock").textContent;
      const logArea = document.getElementById("log-area");
      const entry = `[${ts}] ${action}`;
      logArea.textContent = logArea.textContent.trim() === "尚無紀錄"
        ? entry
        : entry + "\n" + logArea.textContent;
    }
    function clearLog() {
      document.getElementById("log-area").textContent = "尚無紀錄";
    }

    // ===== 登入表單處理 =====
    function handleLoginSubmit(e) {
      e.preventDefault();
      const name = document.getElementById('loginName').value.trim();
      if (!name) {
        alert('請輸入姓名');
        return;
      }
      currentUser = name;
      // 重置時鐘
      clockBase = new Date();
      clockOffset = 0;
      updateClock();

      updateNavbarUI();
      const modalInstance = bootstrap.Modal.getInstance(document.getElementById('loginModal'));
      if (modalInstance) {
        modalInstance.hide();
        setTimeout(() => {
          const loginBtn = document.querySelector('.btn-login');
          if (loginBtn && loginBtn.offsetParent !== null) {
            loginBtn.focus();
          }
        }, 300);
      }
      addLog(`${currentUser}，登入成功！`);
    }

    // ===== 主頁按鈕事件 =====
    document.getElementById("btnCheckIn").onclick = () => {
      if (currentUser) {
        addLog(`${currentUser}，簽到成功！`);
      } else {
        addLog("請先登入再簽到！");
      }
    };
    document.getElementById("btnCheckOut").onclick = () => {
      if (currentUser) {
        addLog(`${currentUser}，簽退成功！`);
      } else {
        addLog("請先登入再簽退！");
      }
    };
    document.getElementById("btnClearLog").onclick = clearLog;

    // ===== 初始化 Partial 載入 =====
    loadPart("#site-header", "./navbar.html");
    loadPart("#site-footer", "./footer.html");
  </script>

  <script src="assets/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>